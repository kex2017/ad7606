# 单片机程序说明

单片机程序完成对 FPGA 的数据采集，并将数据传送至主站

## 功能线程说明

1. 主线程：硬件初始化、 FPGA下载、其他线程初始化、看门狗初始化、命令行响应
2. 交互协议处理线程：响应与主站之间的交互协议命令
3. 4G数据接收/发送线程：接收主站发送数据，并将完整协议帧通过消息队列发送到协议处理线程/通过消息队列接收其他线程对主站的数据，并发送给主站
4. 心跳-看门狗线程：喂狗并给主站发送心跳信息
5. 局放原始波形事件处理线程：等待局放中断通知，去读取fpga高频局放波形，并保存，g_pd_to_read_data_flag 置上

## 线缆交互协议处理线程

1. 接收4G 数据接收模块发送的协议帧

2. 解析协议帧并响应请求
Java下发操作码 
   * 0x52 读取高频局放通道数据

   * 0x5c 读取采集卡信息(read_collector_info_req_handler)

   * 0x68 升级文件传输(upload_file_req_handler)

   * 0x70 局放原始波形门限设置命令(pd_threshold_req_handler)

   * 0x72 局放原始波形事件查询命令(search_pd_req_handler)

   * 0x74 读取局放原始波形数据命令(read_pd_curve_req_handler)

   * 0xa7 设置时间命令(set_device_time_handler)

   * 0xa5 查询版本命令(send_device_version_handler)

   * 0x80 重启FPGA或者ARM命令(reboot_fpga_or_arm)

## 局放原始波形事件处理线程

 当线缆交互协议处理线程线程接收到主站下发的查询局放原始波形数据请求时，根据g_pd_to_read_data_flag标志判断当前是否需要发送原始波形数据

